<% layout('../layout') -%>
<script type="text/javascript">
    $(function () {

        function postData() {
            var jqXHR = $.post('/api/users/login', $('form').serialize())
            .done(function (data) {
                if (data.status == 200) {
                    $("#messenger").html(data.message);
                    console.log("done " + data.message);
                    $("#messenger").fadeIn("slow");
                    document.location.href = '/';
                }
                if (data.status == 500) {
                    $("#messenger").html(data.message);
                    console.log("fail " + data.message);
                    $("#messenger").fadeIn("slow");
                }
            });



        }

        function isValidEmailAddress(emailAddress) {
            var pattern = new RegExp(/^(("[\w-\s]+")|([\w-]+(?:\.[\w-]+)*)|("[\w-\s]+")([\w-]+(?:\.[\w-]+)*))(@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$)|(@\[?((25[0-5]\.|2[0-4][0-9]\.|1[0-9]{2}\.|[0-9]{1,2}\.))((25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\.){2}(25[0-5]|2[0-4][0-9]|1[0-9]{2}|[0-9]{1,2})\]?$)/i);
            return pattern.test(emailAddress);
        }


        var field = new Array("email", "password"); //поля обязательные 

        $("form").submit(function () {// обрабатываем отправку формы  
            var error = 0; // индекс ошибки
            $("form").find(":input").each(function () {// проверяем каждое поле в форме
                for (var i = 0; i < field.length; i++) { // если поле присутствует в списке обязательных
                    if ($(this).attr("name") == field[i]) { //проверяем поле формы на пустоту

                        if (!$(this).val()) {// если в поле пустое
                            $(this).css('border', 'red 1px solid'); // устанавливаем рамку красного цвета
                            error = 1; // определяем индекс ошибки       

                        }
                        else {
                            $(this).css('border', 'gray 1px solid'); // устанавливаем рамку обычного цвета
                        }

                    }
                }
            })

            var email = $("#email").val();
            if (!isValidEmailAddress(email)) {
                error = 2;
            }

            if (error == 0) { // если ошибок нет то отправляем данные
                postData();
                return false;
            }
            else {
                if (error == 1) var err_text = "Не все обязательные поля заполнены!";
                if (error == 2) var err_text = "Email введен неверно";
                $("#messenger").html(err_text);
                $("#messenger").fadeIn("slow");
                return false; //если в форме встретились ошибки , не  позволяем отослать данные на сервер.
            }



        })
    });

</script>
<div class="admin_page">
<div class="admin_content">
    <div class="admin_info">
        <h3>Вход</h3>
        <form method="post" action="" class="horizontal">
            <div id ="messenger" class="messenger"> </div>
            <div class="form_item">
                <div class="label">email</div>
                <div class="input"><input id="email" type="email" size="60" name="email" required></div>
            </div>
            <div class="form_item">
                <div class="label">Пароль</div>
                <div class="input"><input type="password" size="60" name="password" required></div>
            </div>
            <div class="form_item">
                <a href="/users/newuser">Регистрация</a>/<a href="/users/forgot-password">Забыли пароль?</a>
            </div>
            <div class="form_but">
                <input type="submit" value="Войти" class="button succes">
                <a href="/" class="button simple">Отмена</a>
            </div>
        </form>
    </div>
</div>
</div>